# RA2 INI Assistant v1.2.0 更新日志

> 发布日期：2025年12月28日

## ✨ 新增功能

### 1. 🔄 官方批量重命名功能（带预览）

支持通过官方 VS Code RenameProvider 和新增命令进行范围可选的批量重命名。

#### 快速开始
- **快捷键**：在节头或键名上按 `F2`，输入新名称，自动查找并预览所有引用
- **命令**：执行 "INI: 批量重命名（预览）" 命令，可选择重命名范围
  - 🎯 **索引文件（推荐）**：仅在已索引的文件间查找（快速、精准）
  - 📄 **当前文件**：仅在当前文件内进行重命名（安全、快速）
  - 🔍 **全工作区扫描**：扫描所有 INI 文件（完整、可能较慢）

#### 特性
- 交互式预览面板，显示修改前后对比
- 支持按需选择要更新的引用
- 跨多个文件的引用自动更新
- 键名重命名仅在当前文件范围内（避免误伤）
- **长行可横向滚动**：预览面板支持水平滚动，避免长配置行被截断

#### 示例
```ini
原节名: [OldWeapon]
新节名: [NewWeapon]
→ 自动更新所有引用该节的键值
```

---

### 2. 📋 未定义/未使用节检测与快速修复

自动发现 INI 文件中的引用错误和死代码。

#### 诊断类型

**① 未定义的节引用** ⚠️
- 检测值引用指向的节不存在
- 级别：警告（黄色波浪线）
- 快速修复：一键创建缺失的节

示例：
```ini
[Infantry]
Primary=NonExistentWeapon  ← 诊断：未定义的节引用
```

**② 未使用的节** ℹ️
- 检测定义但从不被引用的节
- 级别：信息（蓝色波浪线）
- 快速修复：一键删除未使用的节块

示例：
```ini
[UnusedWeapon]  ← 诊断：节未被引用
Image=test
Cost=500
```

#### 工作方式
- 支持当前文件内检测
- 如启用多文件索引，跨文件检测未定义引用
- 可通过灯泡图标（💡）快速应用修复

#### 配置
```json
// 已默认启用，可通过禁用诊断来关闭
```

---

### 3. 📊 索引与缓存性能监控

暴露内部索引和类型推断系统的实时统计信息。

#### 新增命令
- **命令名**：`INI: 查看索引与缓存状态`
- **位置**：命令面板 (`F1`)

#### 显示内容
```
索引统计：
  • 已索引文件数
  • 总节数
  • 总引用关系数
  • 全局版本号

缓存统计：
  • 类型推断命中次数
  • 类型推断未命中次数
  • 缓存驱逐次数
```

#### 用途
- 诊断索引是否正常初始化
- 了解缓存效率
- 调试多文件搜索问题

---

### 4. 🎯 注册表辅助工具（新增）

智能的注册表节名自动注册功能，支持多种注册模式和跨文件检测。

#### 核心功能

**① 注册表代码补全**
- 在注册表节内输入时，智能补全未注册的节名
- 支持跨文件节名发现（包括 art.ini 等其他文件）
- 根据注册模式自动调整补全触发条件
- 每个补全项显示节来源的注释信息

**② 节头快速注册 CodeAction**
- 在节定义处按 `Ctrl+.` 打开快速修复菜单
- 显示该节类型对应的所有注册表选项（带中文标签）
- 自动检测全局已注册状态，避免重复注册
- 选择后自动生成完整的注册代码

**③ 支持多种注册模式**

**Append 模式**（默认）- 适用于 InfantryTypes、VehicleTypes 等
```ini
[InfantryTypes]
1=AnotherInfantry ; 另一个步兵
+=MyInfantry ; 我的步兵
```

**KeyValue 模式**（如 ArmorTypes）- 特殊注册方式
```ini
[ArmorTypes]
MyArmor=100% ; 自定义装甲（默认100%防护）
LightArmor=50% ; 轻型装甲
```

#### 中文标签显示
所有注册表选项都显示对应的中文描述，如：
- 「注册步兵」
- 「注册载具（车辆 直升机飞艇飞碟 海军）」
- 「装甲注册列表」
- 「武器注册列表」
- 等 20+ 种注册表类型

#### 跨文件智能检测
- 检测全工作区内已注册的节名，避免重复注册
- 自动排除用户已经在其他文件（如 rulesmd.ini）中注册过的节
- **应用白名单配置**：仅在白名单内的文件中搜索，提升性能
- 可通过 `ini-ra2.enableMultiFileSearch` 配置启用/禁用
- 白名单配置通过 `ini-ra2.relatedFiles` 指定

#### 配置支持
translations.json 中支持灵活配置：
```json
{
  "label": "装甲注册列表",
  "value": "[ArmorTypes]",
  "mode": "keyValue",
  "defaultValue": "100%"
}
```
- `mode`：注册模式（append 或 keyValue）
- `defaultValue`：keyValue 模式下的默认值

#### 示例工作流
1. 在 INI 文件中定义新节：`[MyCustomArmor]`
2. 按 `Ctrl+.` 打开快速菜单
3. 选择「注册到 [ArmorTypes] - 装甲注册列表」
4. 自动生成：`MyCustomArmor=100% ; 我的自定义装甲`

---

### 5. 🔍 诊断系统改进（新增）

#### 注册表节名排除
- 诊断系统现在直接从 `registerType` 读取注册表节名
- 自动排除所有注册表节（如 ArmorTypes、InfantryTypes），不显示「未被引用」警告
- 配置化管理，无需硬编码修改

#### 索引联动刷新
- 订阅索引变更事件，跨文件更新后自动对所有已打开 INI 文档重新计算诊断
- 解决初始化或他处编辑后当前文件蓝色波浪线未及时消失/出现的问题

#### 性能优化
- 优化了诊断数据结构，减少重复计算
- 更高效的节名对比逻辑

---

## 🔧 优化

### 1. 重命名系统重构
- 新增 `identifySymbolAtPosition()` 方法，精确识别光标处的节或键名
- 新增 `buildEditForProvider()` 方法，为 RenameProvider 构建 WorkspaceEdit
- 新增 `findReferences()` 的范围参数，支持灵活的搜索策略
- 重构 `buildWorkspaceEdit()` 为公共方法，供命令和提供器共用

### 2. 诊断增强
- 集成 IniIndexManager，支持跨文件未定义检测
- 收集值引用信息，精准定位引用来源
- 区分诊断类型：错误（未定义）、警告（重复定义）、信息（未使用）
- 支持通过诊断代码快速识别问题类型
- 索引更新时自动刷新打开文档的诊断，保持跨文件状态同步

### 3. 性能指标暴露
- IniIndexManager 新增 `getStats()` 方法
- TypeInference 已有 `getCacheStats()` 方法
- 命令面板集成统计显示

### 4. 翻译加载系统优化
- TranslationLoader 改为自动合并所有 JSON 字段，避免硬编码
- 新增 registerType 字段初始化，确保加载完整
- reload() 方法正确重置所有字段

### 5. 注册表系统架构
- 新增 RegisterHelper 类，集中管理注册表逻辑
- 支持配置化的 mode 和 defaultValue
- 提供 getRegisterConfig()、getRegisterMode() 等工具方法
- 完整的跨文件检测和全局状态管理

---

## 🐛 Bug 修复

| 问题 | 描述 | 状态 |
|------|------|------|
| 格式化不生效 | 多个 formattingProvider 注册冲突 | ✅ 已修复 |
| 诊断节名重复处理 | 节名处理流程中存在冗余逻辑 | ✅ 已修复 |
| 引用检测不准确 | 缺少对多种值格式的解析 | ✅ 改进 |
| 注册表节未被排除 | 诊断系统应排除所有注册表节（如 ArmorTypes） | ✅ 已修复 |
| registerType 未加载 | TranslationLoader 没有加载 registerType 字段 | ✅ 已修复 |
| ArmorTypes keyValue 模式补全 | 补全生成 `key=` 而非 `key=100%` | ✅ 已修复 |

---

## 📦 包含的命令

### 已有命令
- `ini-ra2.checkDuplicates` - 检查重复配置
- `ini-ra2.rebuildIndex` - 重建文件索引
- `ini-ra2.insertIniReference` - 插入配置参考
- `ini-ra2.showStatistics` - 显示统计信息
- `ini-ra2.batchRenameKeys` - 批量重命名键（旧版）

### 新增命令
- `ini-ra2.batchRename` - 批量重命名（预览，支持范围选择）
- `ini-ra2.showIndexStats` - 查看索引与缓存状态
- `ini-ra2.registerSection` - 注册节到指定的注册表（由 RegisterHelper 提供）

### 快捷键
- `Ctrl+Shift+A` - 插入 INI 参考
- `F2` - 重命名节/键（新增）

---

## 🔄 迁移指南

### 从旧版批量重命名升级
- 旧命令 `ini-ra2.batchRenameKeys` 仍可用
- 推荐切换到新命令 `ini-ra2.batchRename`，具有范围选择和更好的性能

### 诊断配置
- 未定义节引用诊断：默认启用（警告级别）
- 未使用节诊断：默认启用（信息级别）
- 可在 VS Code 设置中调整诊断严重程度或禁用

---

## 📝 已知限制

1. **键名重命名范围**：键名重命名仅在当前文件内进行，避免跨文件误伤
2. **未使用节检测**：无法检测被注释行引用的节
3. **跨文件诊断**：需启用 `enableMultiFileSearch` 才能进行跨文件检测
4. **注册表补全触发**：keyValue 模式下需确保光标在行首或符合触发条件
5. **默认值限制**：defaultValue 仅适用于 keyValue 模式，append 模式不支持

---

## 🙏 贡献者

感谢所有提出建议和反馈的用户！

---

## 📞 反馈与报告

如遇到问题或有功能建议，欢迎在以下方式联系：
- GitHub Issues: [RA2-INI-Assistant](https://github.com/LufeiQD/RA2-INI-Assistant/issues)
- 作者 QQ：183354595

---

**本版本基于 v1.1.0，推荐所有用户升级。**
